<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<script type="text/javascript">
const MAX_COUNT_SIZE = 9999;
const INTERVAL_S = 1000 * 60; // 1 minute
const INTERVAL_E = 1000 * 60 * 60; // 1 hour
const COLOR_S = [050, 150, 050, 230];
const COLOR_E = [200, 050, 050, 230];
const targetURI = 'http://akirawebapps.appspot.com/';
const getBadgeTextURI = 'http://akirawebapps.appspot.com/gfriends/getBadgeText?lastCheckout=';
var lastCheckout = 0;
var count = 0;
var newLastCheckout = 0;

var update = function(count) {
  chrome.browserAction.setBadgeText({text : count});
};

var check = function() {

  console.log("before:" + lastCheckout);
  
  var xhr = new XMLHttpRequest();
  var uri = getBadgeTextURI + lastCheckout;
  xhr.open('POST', uri, true);
  xhr.onload = function(){
    var result = eval("("+ xhr.responseText +")");
    console.log("size:" + result.size);
    console.log("newLastCheckout:" + result.newLastCheckout);
    var oldCount = count;
    count = result.size;
    if (count >= 0) {
        showNotification(count - oldCount);
      if(count > oldCount){
        showNotification(count - oldCount);
      }
      chrome.browserAction.setBadgeBackgroundColor({color : COLOR_S});
      update(count.toString());
      setTimeout(check, INTERVAL_S);
    } else {
      error();
    }
  };
  
  xhr.onerror = function(){
    error();
  };
  
  xhr.send(null);
};

var error = function() {
  chrome.browserAction.setBadgeBackgroundColor({color : COLOR_E});
  update('!');
  setTimeout(check, INTERVAL_E);
};

var showTargetPage = function() {
  chrome.tabs.getAllInWindow(undefined, function(tabs) {
    for (var i = 0, tab; tab = tabs[i]; i++) {
      if (tab.url && targetURI == tab.url) {
        chrome.tabs.update(tab.id, {url: targetURI,selected: true});
        return;
      }
    }
    chrome.tabs.create({url: targetURI});
  });
};

chrome.browserAction.setBadgeText({text : '?'});
chrome.browserAction.setBadgeBackgroundColor({color : COLOR_E});
chrome.browserAction.onClicked.addListener(function(tab) {
  showTargetPage();
  count = 0;
  lastCheckout = newLastCheckout;
  localStorage.gfriends_lastCheckout = lastCheckout;
  console.log("save!!!");
  chrome.browserAction.setBadgeBackgroundColor({color : COLOR_S});
  update(count.toString());
  console.log("after click:" + lastCheckout);
});
chrome.extension.onRequest.addListener(function(res){
  showTargetPage();
});

function showNotification(messageNum) {
  // 許可をチェック
  if (webkitNotifications.permissionLevel === webkitNotifications.PERMISSION_ALLOWED) {
    //var notification = webkitNotifications.createNotification('icon48.png', 'メッセージ通知', messageNum + "通が届きました。");
    var notification = webkitNotifications.createHTMLNotification("messageHTML.html?message=" + messageNum);
    notification.ondisplay = function(){
      // 表示されてから3秒後に自動で閉じる
      setTimeout(function(){notification.cancel();},6000);
    };
    notification.show();
  } else {
    // ユーザに許可を得る
    webkitNotifications.requestPermission(function() {
      if (webkitNotifications.permissionLevel === webkitNotifications.PERMISSION_ALLOWED) {
        showNotification(messageNum);
      }
    });
  }
}

init = function(){
  if(localStorage.gfriends_lastCheckout){
    lastCheckout = localStorage.gfriends_lastCheckout;
      console.log("load!!!");
  }
  check();
};

</script>
</head>
<body onload="init();">
</body>
</html>